# Phase 2 Plan: Authentication System

**Phase:** 2 - Authentication System  
**Goal:** Users can securely create accounts and authenticate via email/password or Google OAuth.

---

## Plan Overview

| Plan ID | Name | Wave | Est. Time | Autonomous |
|---------|------|------|-----------|------------|
| 02-01 | Firebase Project Setup | 1 | 15 min | Yes |
| 02-02 | Add Firebase Dependencies | 1 | 10 min | Yes |
| 02-03 | Create Auth Repository Interface | 2 | 15 min | Yes |
| 02-04 | Implement Firebase Auth Repository | 2 | 25 min | Yes |
| 02-05 | Create Auth Use Cases | 3 | 20 min | Yes |
| 02-06 | Configure Auth Providers | 3 | 15 min | Yes |
| 02-07 | Build Login Page UI | 4 | 25 min | Yes |
| 02-08 | Build Register Page UI | 4 | 20 min | Yes |
| 02-09 | Implement Password Reset | 5 | 15 min | Yes |
| 02-10 | Auth Flow Integration | 5 | 20 min | Yes |
| 02-11 | Test Auth Flows | 6 | 15 min | Yes |

**Total Plans:** 11  
**Total Est. Time:** ~3 hours  
**Waves:** 6

---

## Wave 1: Firebase Setup (25 min)

### Plan 02-01: Firebase Project Setup

**Task:** Create Firebase project and download configuration

```xml
<task>
  <action>Create Firebase project</action>
  <steps>
    1. Go to https://console.firebase.google.com
    2. Click "Create a project"
    3. Name: "voiceflow-notes"
    4. Enable Google Analytics (optional for now)
    5. Wait for project creation
  </steps>
</task>

<task>
  <action>Register Android app</action>
  <steps>
    1. Click "Add app" → Android
    2. Package name: com.voiceflow.voiceflow_notes
    3. App nickname: "VoiceFlow Android"
    4. Debug signing certificate SHA-1:
       cd android
       ./gradlew signingReport
       (Copy SHA-1 from debug config)
    5. Download google-services.json
    6. Move to android/app/google-services.json
  </steps>
</task>

<task>
  <action>Register Web app</action>
  <steps>
    1. Click "Add app" → Web
    2. App nickname: "VoiceFlow Web"
    3. Copy firebaseConfig object (will use in Phase 5)
  </steps>
</task>

<task>
  <action>Enable Authentication methods</action>
  <steps>
    1. Go to Build → Authentication
    2. Click "Get started"
    3. Enable "Email/Password" provider
    4. Enable "Google" provider
    5. Add support email (your email)
    6. Save
  </steps>
</task>
```

**Files Modified:**
- `android/app/google-services.json` (downloaded)

**Must Haves for Success:**
- [ ] Firebase project created
- [ ] Android app registered with SHA-1
- [ ] google-services.json in correct location
- [ ] Email/Password and Google auth enabled

---

### Plan 02-02: Add Firebase Dependencies

**Task:** Configure FlutterFire and add Firebase packages

```xml
<task>
  <action>Install FlutterFire CLI</action>
  <command>dart pub global activate flutterfire_cli</command>
</task>

<task>
  <action>Update pubspec.yaml</action>
  <edit file="pubspec.yaml">
    dependencies:
      # ... existing dependencies ...
      
      # Firebase
      firebase_auth: ^5.5.1
      google_sign_in: ^6.3.0
      
    dev_dependencies:
      # ... existing ...
  </edit>
</task>

<task>
  <action>Get dependencies</action>
  <command>flutter pub get</command>
</task>

<task>
  <action>Configure Firebase for project</action>
  <command>flutterfire configure</command>
  <note>Select platforms: android, web</note>
</task>

<task>
  <action>Update main.dart for Firebase</action>
  <edit file="lib/main.dart">
    import 'package:firebase_core/firebase_core.dart';
    import 'package:voiceflow_notes/firebase_options.dart';
    
    void main() async {
      WidgetsFlutterBinding.ensureInitialized();
      
      // Initialize Firebase
      await Firebase.initializeApp(
        options: DefaultFirebaseOptions.currentPlatform,
      );
      
      // Initialize local database
      final container = ProviderContainer();
      final db = container.read(localDatabaseProvider);
      await db.initialize();
      
      runApp(
        UncontrolledProviderScope(
          container: container,
          child: const VoiceFlowApp(),
        ),
      );
    }
  </edit>
</task>

<task>
  <action>Verify Firebase initializes</action>
  <command>flutter run</command>
  <verify>No Firebase errors in console</verify>
</task>
```

**Files Modified:**
- `pubspec.yaml`
- `lib/main.dart`
- `lib/firebase_options.dart` (generated by flutterfire)

**Must Haves for Success:**
- [ ] `flutter pub get` succeeds
- [ ] `flutterfire configure` completes
- [ ] App runs without Firebase errors
- [ ] firebase_options.dart generated

---

## Wave 2: Repository Layer (40 min)

### Plan 02-03: Create Auth Repository Interface

**Task:** Define auth repository contract

```xml
<task>
  <action>Create User entity</action>
  <write file="lib/domain/entities/user.dart">
    import 'package:equatable/equatable.dart';

    class User extends Equatable {
      final String id;
      final String? email;
      final String? displayName;
      final String? photoUrl;
      final bool isEmailVerified;

      const User({
        required this.id,
        this.email,
        this.displayName,
        this.photoUrl,
        this.isEmailVerified = false,
      });

      const User.anonymous()
          : id = '',
            email = null,
            displayName = null,
            photoUrl = null,
            isEmailVerified = false;

      bool get isAuthenticated => id.isNotEmpty;

      @override
      List<Object?> get props => [id, email, displayName, photoUrl, isEmailVerified];
    }
  </write>
</task>

<task>
  <action>Create AuthRepository interface</action>
  <write file="lib/domain/repositories/auth_repository.dart">
    import 'package:voiceflow_notes/core/utils/result.dart';
    import 'package:voiceflow_notes/domain/entities/user.dart';

    abstract class AuthRepository {
      /// Get current user
      User get currentUser;

      /// Stream of auth state changes
      Stream<User> get authStateChanges;

      /// Sign in with email and password
      Future<Result<User>> signInWithEmailAndPassword(String email, String password);

      /// Create account with email and password
      Future<Result<User>> createUserWithEmailAndPassword(String email, String password);

      /// Sign in with Google
      Future<Result<User>> signInWithGoogle();

      /// Send password reset email
      Future<Result<void>> sendPasswordResetEmail(String email);

      /// Sign out
      Future<Result<void>> signOut();
    }
  </write>
</task>

<task>
  <action>Create AuthException types</action>
  <edit file="lib/core/errors/app_exception.dart">
    // Add to existing file:
    
    class AuthException extends AppException {
      final AuthErrorCode code;
      
      const AuthException(this.code, super.message, {super.stackTrace})
          : super(code: code.name);
    }

    enum AuthErrorCode {
      invalidEmail,
      userDisabled,
      userNotFound,
      wrongPassword,
      emailAlreadyInUse,
      weakPassword,
      networkError,
      unknown,
    }
  </edit>
</task>
```

**Files Modified:**
- `lib/domain/entities/user.dart`
- `lib/domain/repositories/auth_repository.dart`
- `lib/core/errors/app_exception.dart`

**Must Haves for Success:**
- [ ] User entity with all fields
- [ ] AuthRepository interface complete
- [ ] AuthException with error codes

---

### Plan 02-04: Implement Firebase Auth Repository

**Task:** Implement AuthRepository with Firebase

```xml
<task>
  <action>Create FirebaseAuthRepository</action>
  <write file="lib/data/repositories/firebase_auth_repository.dart">
    import 'package:firebase_auth/firebase_auth.dart' as firebase;
    import 'package:google_sign_in/google_sign_in.dart';
    import 'package:voiceflow_notes/core/errors/app_exception.dart';
    import 'package:voiceflow_notes/core/utils/result.dart';
    import 'package:voiceflow_notes/domain/entities/user.dart';
    import 'package:voiceflow_notes/domain/repositories/auth_repository.dart';

    class FirebaseAuthRepository implements AuthRepository {
      final firebase.FirebaseAuth _firebaseAuth;
      final GoogleSignIn _googleSignIn;

      FirebaseAuthRepository({
        firebase.FirebaseAuth? firebaseAuth,
        GoogleSignIn? googleSignIn,
      })  : _firebaseAuth = firebaseAuth ?? firebase.FirebaseAuth.instance,
            _googleSignIn = googleSignIn ?? GoogleSignIn();

      @override
      User get currentUser {
        final firebaseUser = _firebaseAuth.currentUser;
        return firebaseUser != null ? _mapFirebaseUser(firebaseUser) : const User.anonymous();
      }

      @override
      Stream<User> get authStateChanges {
        return _firebaseAuth.authStateChanges().map((firebaseUser) {
          return firebaseUser != null ? _mapFirebaseUser(firebaseUser) : const User.anonymous();
        });
      }

      @override
      Future<Result<User>> signInWithEmailAndPassword(String email, String password) async {
        try {
          final credential = await _firebaseAuth.signInWithEmailAndPassword(
            email: email,
            password: password,
          );
          return Success(_mapFirebaseUser(credential.user!));
        } on firebase.FirebaseAuthException catch (e) {
          return Failure(_mapFirebaseError(e));
        } catch (e, stackTrace) {
          return Failure(AuthException(AuthErrorCode.unknown, e.toString(), stackTrace: stackTrace));
        }
      }

      @override
      Future<Result<User>> createUserWithEmailAndPassword(String email, String password) async {
        try {
          final credential = await _firebaseAuth.createUserWithEmailAndPassword(
            email: email,
            password: password,
          );
          return Success(_mapFirebaseUser(credential.user!));
        } on firebase.FirebaseAuthException catch (e) {
          return Failure(_mapFirebaseError(e));
        } catch (e, stackTrace) {
          return Failure(AuthException(AuthErrorCode.unknown, e.toString(), stackTrace: stackTrace));
        }
      }

      @override
      Future<Result<User>> signInWithGoogle() async {
        try {
          final GoogleSignInAccount? googleUser = await _googleSignIn.signIn();
          if (googleUser == null) {
            return const Failure(AuthException(AuthErrorCode.unknown, 'Google sign-in cancelled'));
          }

          final GoogleSignInAuthentication googleAuth = await googleUser.authentication;
          final credential = firebase.GoogleAuthProvider.credential(
            accessToken: googleAuth.accessToken,
            idToken: googleAuth.idToken,
          );

          final userCredential = await _firebaseAuth.signInWithCredential(credential);
          return Success(_mapFirebaseUser(userCredential.user!));
        } on firebase.FirebaseAuthException catch (e) {
          return Failure(_mapFirebaseError(e));
        } catch (e, stackTrace) {
          return Failure(AuthException(AuthErrorCode.unknown, e.toString(), stackTrace: stackTrace));
        }
      }

      @override
      Future<Result<void>> sendPasswordResetEmail(String email) async {
        try {
          await _firebaseAuth.sendPasswordResetEmail(email: email);
          return const Success(null);
        } on firebase.FirebaseAuthException catch (e) {
          return Failure(_mapFirebaseError(e));
        } catch (e, stackTrace) {
          return Failure(AuthException(AuthErrorCode.unknown, e.toString(), stackTrace: stackTrace));
        }
      }

      @override
      Future<Result<void>> signOut() async {
        try {
          await Future.wait([
            _firebaseAuth.signOut(),
            _googleSignIn.signOut(),
          ]);
          return const Success(null);
        } catch (e, stackTrace) {
          return Failure(AuthException(AuthErrorCode.unknown, e.toString(), stackTrace: stackTrace));
        }
      }

      User _mapFirebaseUser(firebase.User firebaseUser) {
        return User(
          id: firebaseUser.uid,
          email: firebaseUser.email,
          displayName: firebaseUser.displayName,
          photoUrl: firebaseUser.photoURL,
          isEmailVerified: firebaseUser.emailVerified,
        );
      }

      AuthException _mapFirebaseError(firebase.FirebaseAuthException e) {
        final code = switch (e.code) {
          'invalid-email' => AuthErrorCode.invalidEmail,
          'user-disabled' => AuthErrorCode.userDisabled,
          'user-not-found' => AuthErrorCode.userNotFound,
          'wrong-password' => AuthErrorCode.wrongPassword,
          'email-already-in-use' => AuthErrorCode.emailAlreadyInUse,
          'weak-password' => AuthErrorCode.weakPassword,
          'network-request-failed' => AuthErrorCode.networkError,
          _ => AuthErrorCode.unknown,
        };
        
        final message = switch (code) {
          AuthErrorCode.invalidEmail => 'Please enter a valid email address',
          AuthErrorCode.userDisabled => 'This account has been disabled',
          AuthErrorCode.userNotFound => 'No account found with this email',
          AuthErrorCode.wrongPassword => 'Incorrect password. Please try again',
          AuthErrorCode.emailAlreadyInUse => 'An account already exists with this email',
          AuthErrorCode.weakPassword => 'Password must be at least 8 characters',
          AuthErrorCode.networkError => 'Please check your internet connection',
          _ => e.message ?? 'An authentication error occurred',
        };
        
        return AuthException(code, message);
      }
    }
  </write>
</task>

<task>
  <action>Verify no compile errors</action>
  <command>flutter analyze</command>
</task>
```

**Files Modified:**
- `lib/data/repositories/firebase_auth_repository.dart`

**Must Haves for Success:**
- [ ] FirebaseAuthRepository implements all methods
- [ ] Firebase errors mapped to AppException
- [ ] User-friendly error messages
- [ ] No analysis errors

---

## Wave 3: Use Cases & Providers (35 min)

### Plan 02-05: Create Auth Use Cases

**Task:** Create use cases for each auth operation

```xml
<task>
  <action>Create SignInUseCase</action>
  <write file="lib/domain/usecases/sign_in_usecase.dart">
    import 'package:voiceflow_notes/core/utils/result.dart';
    import 'package:voiceflow_notes/domain/entities/user.dart';
    import 'package:voiceflow_notes/domain/repositories/auth_repository.dart';
    import 'package:voiceflow_notes/domain/usecases/usecase.dart';

    class SignInParams {
      final String email;
      final String password;

      const SignInParams({
        required this.email,
        required this.password,
      });
    }

    class SignInUseCase implements UseCase<User, SignInParams> {
      final AuthRepository _authRepository;

      SignInUseCase(this._authRepository);

      @override
      Future<Result<User>> call(SignInParams params) {
        return _authRepository.signInWithEmailAndPassword(
          params.email,
          params.password,
        );
      }
    }
  </write>
</task>

<task>
  <action>Create SignUpUseCase</action>
  <write file="lib/domain/usecases/sign_up_usecase.dart">
    import 'package:voiceflow_notes/core/utils/result.dart';
    import 'package:voiceflow_notes/domain/entities/user.dart';
    import 'package:voiceflow_notes/domain/repositories/auth_repository.dart';
    import 'package:voiceflow_notes/domain/usecases/usecase.dart';

    class SignUpParams {
      final String email;
      final String password;

      const SignUpParams({
        required this.email,
        required this.password,
      });
    }

    class SignUpUseCase implements UseCase<User, SignUpParams> {
      final AuthRepository _authRepository;

      SignUpUseCase(this._authRepository);

      @override
      Future<Result<User>> call(SignUpParams params) {
        return _authRepository.createUserWithEmailAndPassword(
          params.email,
          params.password,
        );
      }
    }
  </write>
</task>

<task>
  <action>Create SignOutUseCase</action>
  <write file="lib/domain/usecases/sign_out_usecase.dart">
    import 'package:voiceflow_notes/core/utils/result.dart';
    import 'package:voiceflow_notes/domain/repositories/auth_repository.dart';
    import 'package:voiceflow_notes/domain/usecases/usecase.dart';

    class SignOutUseCase implements UseCase<void, NoParams> {
      final AuthRepository _authRepository;

      SignOutUseCase(this._authRepository);

      @override
      Future<Result<void>> call(NoParams params) {
        return _authRepository.signOut();
      }
    }
  </write>
</task>

<task>
  <action>Create ResetPasswordUseCase</action>
  <write file="lib/domain/usecases/reset_password_usecase.dart">
    import 'package:voiceflow_notes/core/utils/result.dart';
    import 'package:voiceflow_notes/domain/repositories/auth_repository.dart';
    import 'package:voiceflow_notes/domain/usecases/usecase.dart';

    class ResetPasswordParams {
      final String email;

      const ResetPasswordParams({required this.email});
    }

    class ResetPasswordUseCase implements UseCase<void, ResetPasswordParams> {
      final AuthRepository _authRepository;

      ResetPasswordUseCase(this._authRepository);

      @override
      Future<Result<void>> call(ResetPasswordParams params) {
        return _authRepository.sendPasswordResetEmail(params.email);
      }
    }
  </write>
</task>

<task>
  <action>Create SignInWithGoogleUseCase</action>
  <write file="lib/domain/usecases/sign_in_with_google_usecase.dart">
    import 'package:voiceflow_notes/core/utils/result.dart';
    import 'package:voiceflow_notes/domain/entities/user.dart';
    import 'package:voiceflow_notes/domain/repositories/auth_repository.dart';
    import 'package:voiceflow_notes/domain/usecases/usecase.dart';

    class SignInWithGoogleUseCase implements UseCase<User, NoParams> {
      final AuthRepository _authRepository;

      SignInWithGoogleUseCase(this._authRepository);

      @override
      Future<Result<User>> call(NoParams params) {
        return _authRepository.signInWithGoogle();
      }
    }
  </write>
</task>
```

**Files Modified:**
- `lib/domain/usecases/sign_in_usecase.dart`
- `lib/domain/usecases/sign_up_usecase.dart`
- `lib/domain/usecases/sign_out_usecase.dart`
- `lib/domain/usecases/reset_password_usecase.dart`
- `lib/domain/usecases/sign_in_with_google_usecase.dart`

**Must Haves for Success:**
- [ ] All 5 use cases created
- [ ] Each implements UseCase interface
- [ ] No analysis errors

---

### Plan 02-06: Configure Auth Providers

**Task:** Setup Riverpod providers for auth

```xml
<task>
  <action>Create auth providers file</action>
  <write file="lib/presentation/providers/auth_provider.dart">
    import 'package:flutter_riverpod/flutter_riverpod.dart';
    import 'package:voiceflow_notes/data/repositories/firebase_auth_repository.dart';
    import 'package:voiceflow_notes/domain/entities/user.dart';
    import 'package:voiceflow_notes/domain/repositories/auth_repository.dart';
    import 'package:voiceflow_notes/domain/usecases/sign_in_usecase.dart';
    import 'package:voiceflow_notes/domain/usecases/sign_up_usecase.dart';
    import 'package:voiceflow_notes/domain/usecases/sign_out_usecase.dart';
    import 'package:voiceflow_notes/domain/usecases/reset_password_usecase.dart';
    import 'package:voiceflow_notes/domain/usecases/sign_in_with_google_usecase.dart';
    import 'package:voiceflow_notes/domain/usecases/usecase.dart';

    // Repository
    final authRepositoryProvider = Provider<AuthRepository>((ref) {
      return FirebaseAuthRepository();
    });

    // Auth state stream
    final authStateProvider = StreamProvider<User>((ref) {
      final repository = ref.watch(authRepositoryProvider);
      return repository.authStateChanges;
    });

    // Current user
    final currentUserProvider = Provider<User>((ref) {
      final repository = ref.watch(authRepositoryProvider);
      return repository.currentUser;
    });

    // Use cases
    final signInUseCaseProvider = Provider<SignInUseCase>((ref) {
      return SignInUseCase(ref.watch(authRepositoryProvider));
    });

    final signUpUseCaseProvider = Provider<SignUpUseCase>((ref) {
      return SignUpUseCase(ref.watch(authRepositoryProvider));
    });

    final signOutUseCaseProvider = Provider<SignOutUseCase>((ref) {
      return SignOutUseCase(ref.watch(authRepositoryProvider));
    });

    final resetPasswordUseCaseProvider = Provider<ResetPasswordUseCase>((ref) {
      return ResetPasswordUseCase(ref.watch(authRepositoryProvider));
    });

    final signInWithGoogleUseCaseProvider = Provider<SignInWithGoogleUseCase>((ref) {
      return SignInWithGoogleUseCase(ref.watch(authRepositoryProvider));
    });

    // Auth state notifier for UI
    class AuthStateNotifier extends StateNotifier<AsyncValue<User>> {
      final AuthRepository _repository;

      AuthStateNotifier(this._repository) : super(const AsyncValue.loading()) {
        _init();
      }

      void _init() {
        _repository.authStateChanges.listen((user) {
          state = AsyncValue.data(user);
        });
      }

      Future<void> signOut() async {
        await _repository.signOut();
      }
    }

    final authStateNotifierProvider = StateNotifierProvider<AuthStateNotifier, AsyncValue<User>>((ref) {
      return AuthStateNotifier(ref.watch(authRepositoryProvider));
    });
  </write>
</task>

<task>
  <action>Update error handler for auth</action>
  <edit file="lib/core/utils/error_handler.dart">
    import 'package:flutter/material.dart';
    import 'package:voiceflow_notes/core/errors/app_exception.dart';

    class ErrorHandler {
      static String getUserFriendlyMessage(AppException error) {
        return switch (error) {
          AuthException() => error.message,
          DatabaseException() => 'Unable to save your note. Please try again.',
          NetworkException() => 'No internet connection. Your note is saved locally.',
          ValidationException() => error.message,
          _ => 'Something went wrong. Please try again.',
        };
      }

      static void showError(BuildContext context, AppException error) {
        final message = getUserFriendlyMessage(error);
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(message),
            backgroundColor: Theme.of(context).colorScheme.error,
            behavior: SnackBarBehavior.floating,
            action: SnackBarAction(
              label: 'Dismiss',
              onPressed: () {
                ScaffoldMessenger.of(context).hideCurrentSnackBar();
              },
            ),
          ),
        );
      }
    }
  </edit>
</task>
```

**Files Modified:**
- `lib/presentation/providers/auth_provider.dart`
- `lib/core/utils/error_handler.dart`

**Must Haves for Success:**
- [ ] All providers configured
- [ ] AuthStateNotifier listens to auth changes
- [ ] Error handler updated for AuthException

---

## Wave 4: UI Pages (45 min)

### Plan 02-07: Build Login Page UI

**Task:** Create login screen with email/password and Google sign-in

```xml
<task>
  <action>Create LoginPage</action>
  <write file="lib/presentation/pages/login_page.dart">
    import 'package:flutter/material.dart';
    import 'package:flutter_riverpod/flutter_riverpod.dart';
    import 'package:voiceflow_notes/core/errors/app_exception.dart';
    import 'package:voiceflow_notes/core/utils/error_handler.dart';
    import 'package:voiceflow_notes/domain/usecases/sign_in_usecase.dart';
    import 'package:voiceflow_notes/domain/usecases/sign_in_with_google_usecase.dart';
    import 'package:voiceflow_notes/domain/usecases/usecase.dart';
    import 'package:voiceflow_notes/presentation/providers/auth_provider.dart';
    import 'package:voiceflow_notes/presentation/pages/register_page.dart';

    class LoginPage extends ConsumerStatefulWidget {
      const LoginPage({super.key});

      @override
      ConsumerState<LoginPage> createState() => _LoginPageState();
    }

    class _LoginPageState extends ConsumerState<LoginPage> {
      final _formKey = GlobalKey<FormState>();
      final _emailController = TextEditingController();
      final _passwordController = TextEditingController();
      bool _isLoading = false;

      @override
      void dispose() {
        _emailController.dispose();
        _passwordController.dispose();
        super.dispose();
      }

      Future<void> _signIn() async {
        if (!_formKey.currentState!.validate()) return;

        setState(() => _isLoading = true);

        final useCase = ref.read(signInUseCaseProvider);
        final result = await useCase(SignInParams(
          email: _emailController.text.trim(),
          password: _passwordController.text,
        ));

        setState(() => _isLoading = false);

        if (mounted && result.isFailure) {
          ErrorHandler.showError(context, result.error!);
        }
        // Success: authStateProvider will automatically navigate
      }

      Future<void> _signInWithGoogle() async {
        setState(() => _isLoading = true);

        final useCase = ref.read(signInWithGoogleUseCaseProvider);
        final result = await useCase(const NoParams());

        setState(() => _isLoading = false);

        if (mounted && result.isFailure) {
          ErrorHandler.showError(context, result.error!);
        }
      }

      @override
      Widget build(BuildContext context) {
        return Scaffold(
          body: SafeArea(
            child: Center(
              child: SingleChildScrollView(
                padding: const EdgeInsets.all(24),
                child: Form(
                  key: _formKey,
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    crossAxisAlignment: CrossAxisAlignment.stretch,
                    children: [
                      // Logo/Title
                      Icon(
                        Icons.mic,
                        size: 80,
                        color: Theme.of(context).colorScheme.primary,
                      ),
                      const SizedBox(height: 24),
                      Text(
                        'Welcome to VoiceFlow',
                        style: Theme.of(context).textTheme.headlineMedium,
                        textAlign: TextAlign.center,
                      ),
                      const SizedBox(height: 8),
                      Text(
                        'Sign in to sync your notes',
                        style: Theme.of(context).textTheme.bodyLarge?.copyWith(
                              color: Colors.grey[600],
                            ),
                        textAlign: TextAlign.center,
                      ),
                      const SizedBox(height: 48),

                      // Email field
                      TextFormField(
                        controller: _emailController,
                        keyboardType: TextInputType.emailAddress,
                        decoration: const InputDecoration(
                          labelText: 'Email',
                          prefixIcon: Icon(Icons.email),
                          border: OutlineInputBorder(),
                        ),
                        validator: (value) {
                          if (value == null || value.isEmpty) {
                            return 'Please enter your email';
                          }
                          if (!value.contains('@')) {
                            return 'Please enter a valid email';
                          }
                          return null;
                        },
                      ),
                      const SizedBox(height: 16),

                      // Password field
                      TextFormField(
                        controller: _passwordController,
                        obscureText: true,
                        decoration: const InputDecoration(
                          labelText: 'Password',
                          prefixIcon: Icon(Icons.lock),
                          border: OutlineInputBorder(),
                        ),
                        validator: (value) {
                          if (value == null || value.isEmpty) {
                            return 'Please enter your password';
                          }
                          if (value.length < 6) {
                            return 'Password must be at least 6 characters';
                          }
                          return null;
                        },
                      ),
                      const SizedBox(height: 24),

                      // Sign in button
                      ElevatedButton(
                        onPressed: _isLoading ? null : _signIn,
                        style: ElevatedButton.styleFrom(
                          padding: const EdgeInsets.symmetric(vertical: 16),
                        ),
                        child: _isLoading
                            ? const SizedBox(
                                height: 20,
                                width: 20,
                                child: CircularProgressIndicator(strokeWidth: 2),
                              )
                            : const Text('Sign In', style: TextStyle(fontSize: 16)),
                      ),
                      const SizedBox(height: 16),

                      // Divider
                      Row(
                        children: [
                          Expanded(child: Divider(color: Colors.grey[400])),
                          Padding(
                            padding: const EdgeInsets.symmetric(horizontal: 16),
                            child: Text('OR', style: TextStyle(color: Colors.grey[600])),
                          ),
                          Expanded(child: Divider(color: Colors.grey[400])),
                        ],
                      ),
                      const SizedBox(height: 16),

                      // Google sign in
                      OutlinedButton.icon(
                        onPressed: _isLoading ? null : _signInWithGoogle,
                        icon: const Icon(Icons.g_mobile_data, size: 24),
                        label: const Text('Sign in with Google'),
                        style: OutlinedButton.styleFrom(
                          padding: const EdgeInsets.symmetric(vertical: 16),
                        ),
                      ),
                      const SizedBox(height: 24),

                      // Register link
                      TextButton(
                        onPressed: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(builder: (_) => const RegisterPage()),
                          );
                        },
                        child: const Text("Don't have an account? Sign up"),
                      ),
                    ],
                  ),
                ),
              ),
            ),
          ),
        );
      }
    }
  </write>
</task>
```

**Files Modified:**
- `lib/presentation/pages/login_page.dart`

**Must Haves for Success:**
- [ ] Email and password fields with validation
- [ ] Sign in button with loading state
- [ ] Google sign-in button
- [ ] Link to register page
- [ ] Error handling with SnackBar

---

### Plan 02-08: Build Register Page UI

**Task:** Create registration screen

```xml
<task>
  <action>Create RegisterPage</action>
  <write file="lib/presentation/pages/register_page.dart">
    import 'package:flutter/material.dart';
    import 'package:flutter_riverpod/flutter_riverpod.dart';
    import 'package:voiceflow_notes/core/utils/error_handler.dart';
    import 'package:voiceflow_notes/domain/usecases/sign_up_usecase.dart';
    import 'package:voiceflow_notes/presentation/providers/auth_provider.dart';

    class RegisterPage extends ConsumerStatefulWidget {
      const RegisterPage({super.key});

      @override
      ConsumerState<RegisterPage> createState() => _RegisterPageState();
    }

    class _RegisterPageState extends ConsumerState<RegisterPage> {
      final _formKey = GlobalKey<FormState>();
      final _emailController = TextEditingController();
      final _passwordController = TextEditingController();
      final _confirmPasswordController = TextEditingController();
      bool _isLoading = false;
      bool _obscurePassword = true;
      bool _obscureConfirmPassword = true;

      @override
      void dispose() {
        _emailController.dispose();
        _passwordController.dispose();
        _confirmPasswordController.dispose();
        super.dispose();
      }

      Future<void> _signUp() async {
        if (!_formKey.currentState!.validate()) return;

        setState(() => _isLoading = true);

        final useCase = ref.read(signUpUseCaseProvider);
        final result = await useCase(SignUpParams(
          email: _emailController.text.trim(),
          password: _passwordController.text,
        ));

        setState(() => _isLoading = false);

        if (mounted) {
          if (result.isSuccess) {
            ScaffoldMessenger.of(context).showSnackBar(
              const SnackBar(
                content: Text('Account created successfully!'),
                backgroundColor: Colors.green,
              ),
            );
            // Auth state will auto-navigate to home
          } else {
            ErrorHandler.showError(context, result.error!);
          }
        }
      }

      @override
      Widget build(BuildContext context) {
        return Scaffold(
          appBar: AppBar(
            title: const Text('Create Account'),
            elevation: 0,
          ),
          body: SafeArea(
            child: SingleChildScrollView(
              padding: const EdgeInsets.all(24),
              child: Form(
                key: _formKey,
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.stretch,
                  children: [
                    Text(
                      'Join VoiceFlow',
                      style: Theme.of(context).textTheme.headlineMedium,
                      textAlign: TextAlign.center,
                    ),
                    const SizedBox(height: 8),
                    Text(
                      'Create an account to sync your notes across devices',
                      style: Theme.of(context).textTheme.bodyLarge?.copyWith(
                            color: Colors.grey[600],
                          ),
                      textAlign: TextAlign.center,
                    ),
                    const SizedBox(height: 32),

                    // Email field
                    TextFormField(
                      controller: _emailController,
                      keyboardType: TextInputType.emailAddress,
                      decoration: const InputDecoration(
                        labelText: 'Email',
                        prefixIcon: Icon(Icons.email),
                        border: OutlineInputBorder(),
                      ),
                      validator: (value) {
                        if (value == null || value.isEmpty) {
                          return 'Please enter your email';
                        }
                        if (!value.contains('@')) {
                          return 'Please enter a valid email';
                        }
                        return null;
                      },
                    ),
                    const SizedBox(height: 16),

                    // Password field
                    TextFormField(
                      controller: _passwordController,
                      obscureText: _obscurePassword,
                      decoration: InputDecoration(
                        labelText: 'Password',
                        prefixIcon: const Icon(Icons.lock),
                        suffixIcon: IconButton(
                          icon: Icon(_obscurePassword ? Icons.visibility : Icons.visibility_off),
                          onPressed: () => setState(() => _obscurePassword = !_obscurePassword),
                        ),
                        border: const OutlineInputBorder(),
                      ),
                      validator: (value) {
                        if (value == null || value.isEmpty) {
                          return 'Please enter a password';
                        }
                        if (value.length < 8) {
                          return 'Password must be at least 8 characters';
                        }
                        return null;
                      },
                    ),
                    const SizedBox(height: 16),

                    // Confirm password field
                    TextFormField(
                      controller: _confirmPasswordController,
                      obscureText: _obscureConfirmPassword,
                      decoration: InputDecoration(
                        labelText: 'Confirm Password',
                        prefixIcon: const Icon(Icons.lock_outline),
                        suffixIcon: IconButton(
                          icon: Icon(_obscureConfirmPassword ? Icons.visibility : Icons.visibility_off),
                          onPressed: () => setState(() => _obscureConfirmPassword = !_obscureConfirmPassword),
                        ),
                        border: const OutlineInputBorder(),
                      ),
                      validator: (value) {
                        if (value == null || value.isEmpty) {
                          return 'Please confirm your password';
                        }
                        if (value != _passwordController.text) {
                          return 'Passwords do not match';
                        }
                        return null;
                      },
                    ),
                    const SizedBox(height: 24),

                    // Sign up button
                    ElevatedButton(
                      onPressed: _isLoading ? null : _signUp,
                      style: ElevatedButton.styleFrom(
                        padding: const EdgeInsets.symmetric(vertical: 16),
                      ),
                      child: _isLoading
                          ? const SizedBox(
                              height: 20,
                              width: 20,
                              child: CircularProgressIndicator(strokeWidth: 2),
                            )
                          : const Text('Create Account', style: TextStyle(fontSize: 16)),
                    ),
                    const SizedBox(height: 16),

                    // Sign in link
                    TextButton(
                      onPressed: () => Navigator.pop(context),
                      child: const Text('Already have an account? Sign in'),
                    ),
                  ],
                ),
              ),
            ),
          ),
        );
      }
    }
  </write>
</task>
```

**Files Modified:**
- `lib/presentation/pages/register_page.dart`

**Must Haves for Success:**
- [ ] Email, password, confirm password fields
- [ ] Password validation (8+ chars)
- [ ] Password confirmation matching
- [ ] Loading state
- [ ] Success/error feedback

---

## Wave 5: Password Reset & Auth Flow (35 min)

### Plan 02-09: Implement Password Reset

**Task:** Create forgot password functionality

```xml
<task>
  <action>Create ForgotPasswordPage</action>
  <write file="lib/presentation/pages/forgot_password_page.dart">
    import 'package:flutter/material.dart';
    import 'package:flutter_riverpod/flutter_riverpod.dart';
    import 'package:voiceflow_notes/core/utils/error_handler.dart';
    import 'package:voiceflow_notes/domain/usecases/reset_password_usecase.dart';
    import 'package:voiceflow_notes/presentation/providers/auth_provider.dart';

    class ForgotPasswordPage extends ConsumerStatefulWidget {
      const ForgotPasswordPage({super.key});

      @override
      ConsumerState<ForgotPasswordPage> createState() => _ForgotPasswordPageState();
    }

    class _ForgotPasswordPageState extends ConsumerState<ForgotPasswordPage> {
      final _formKey = GlobalKey<FormState>();
      final _emailController = TextEditingController();
      bool _isLoading = false;
      bool _emailSent = false;

      @override
      void dispose() {
        _emailController.dispose();
        super.dispose();
      }

      Future<void> _sendResetEmail() async {
        if (!_formKey.currentState!.validate()) return;

        setState(() => _isLoading = true);

        final useCase = ref.read(resetPasswordUseCaseProvider);
        final result = await useCase(ResetPasswordParams(
          email: _emailController.text.trim(),
        ));

        setState(() {
          _isLoading = false;
          _emailSent = result.isSuccess;
        });

        if (mounted && result.isFailure) {
          ErrorHandler.showError(context, result.error!);
        }
      }

      @override
      Widget build(BuildContext context) {
        return Scaffold(
          appBar: AppBar(
            title: const Text('Reset Password'),
            elevation: 0,
          ),
          body: SafeArea(
            child: SingleChildScrollView(
              padding: const EdgeInsets.all(24),
              child: Form(
                key: _formKey,
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.stretch,
                  children: [
                    if (!_emailSent) ...[
                      Text(
                        'Forgot your password?',
                        style: Theme.of(context).textTheme.headlineSmall,
                        textAlign: TextAlign.center,
                      ),
                      const SizedBox(height: 8),
                      Text(
                        'Enter your email address and we\'ll send you a link to reset your password.',
                        style: Theme.of(context).textTheme.bodyLarge?.copyWith(
                              color: Colors.grey[600],
                            ),
                        textAlign: TextAlign.center,
                      ),
                      const SizedBox(height: 32),

                      TextFormField(
                        controller: _emailController,
                        keyboardType: TextInputType.emailAddress,
                        decoration: const InputDecoration(
                          labelText: 'Email',
                          prefixIcon: Icon(Icons.email),
                          border: OutlineInputBorder(),
                        ),
                        validator: (value) {
                          if (value == null || value.isEmpty) {
                            return 'Please enter your email';
                          }
                          if (!value.contains('@')) {
                            return 'Please enter a valid email';
                          }
                          return null;
                        },
                      ),
                      const SizedBox(height: 24),

                      ElevatedButton(
                        onPressed: _isLoading ? null : _sendResetEmail,
                        style: ElevatedButton.styleFrom(
                          padding: const EdgeInsets.symmetric(vertical: 16),
                        ),
                        child: _isLoading
                            ? const SizedBox(
                                height: 20,
                                width: 20,
                                child: CircularProgressIndicator(strokeWidth: 2),
                              )
                            : const Text('Send Reset Link', style: TextStyle(fontSize: 16)),
                      ),
                    ] else ...[
                      const Icon(
                        Icons.check_circle_outline,
                        size: 80,
                        color: Colors.green,
                      ),
                      const SizedBox(height: 24),
                      Text(
                        'Check your email',
                        style: Theme.of(context).textTheme.headlineSmall,
                        textAlign: TextAlign.center,
                      ),
                      const SizedBox(height: 8),
                      Text(
                        'We\'ve sent a password reset link to ${_emailController.text}. Please check your inbox and follow the instructions.',
                        style: Theme.of(context).textTheme.bodyLarge?.copyWith(
                              color: Colors.grey[600],
                            ),
                        textAlign: TextAlign.center,
                      ),
                      const SizedBox(height: 32),
                      ElevatedButton(
                        onPressed: () => Navigator.pop(context),
                        child: const Text('Back to Sign In'),
                      ),
                    ],
                  ],
                ),
              ),
            ),
          ),
        );
      }
    }
  </write>
</task>

<task>
  <action>Add forgot password link to LoginPage</action>
  <edit file="lib/presentation/pages/login_page.dart">
    // Add import at top:
    import 'package:voiceflow_notes/presentation/pages/forgot_password_page.dart';

    // Add after "Sign in with Google" button (in build method):
    const SizedBox(height: 16),
    TextButton(
      onPressed: () {
        Navigator.push(
          context,
          MaterialPageRoute(builder: (_) => const ForgotPasswordPage()),
        );
      },
      child: const Text('Forgot password?'),
    ),
  </edit>
</task>
```

**Files Modified:**
- `lib/presentation/pages/forgot_password_page.dart`
- `lib/presentation/pages/login_page.dart`

**Must Haves for Success:**
- [ ] Email input with validation
- [ ] Success state with confirmation
- [ ] Link added to LoginPage

---

### Plan 02-10: Auth Flow Integration

**Task:** Wire auth state to app routing

```xml
<task>
  <action>Create HomePage placeholder</action>
  <write file="lib/presentation/pages/home_page.dart">
    import 'package:flutter/material.dart';
    import 'package:flutter_riverpod/flutter_riverpod.dart';
    import 'package:voiceflow_notes/presentation/providers/auth_provider.dart';

    class HomePage extends ConsumerWidget {
      const HomePage({super.key});

      @override
      Widget build(BuildContext context, WidgetRef ref) {
        final user = ref.watch(currentUserProvider);

        return Scaffold(
          appBar: AppBar(
            title: const Text('VoiceFlow Notes'),
            actions: [
              IconButton(
                icon: const Icon(Icons.logout),
                onPressed: () async {
                  await ref.read(authRepositoryProvider).signOut();
                },
              ),
            ],
          ),
          body: Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                const Icon(Icons.note_alt, size: 80, color: Colors.deepPurple),
                const SizedBox(height: 16),
                Text(
                  'Welcome, ${user.displayName ?? user.email ?? 'User'}!',
                  style: Theme.of(context).textTheme.headlineSmall,
                ),
                const SizedBox(height: 8),
                Text(
                  'Notes feature coming in Phase 5',
                  style: Theme.of(context).textTheme.bodyLarge?.copyWith(
                        color: Colors.grey[600],
                      ),
                ),
              ],
            ),
          ),
        );
      }
    }
  </write>
</task>

<task>
  <action>Update app.dart with auth routing</action>
  <write file="lib/presentation/app.dart">
    import 'package:flutter/material.dart';
    import 'package:flutter_riverpod/flutter_riverpod.dart';
    import 'package:voiceflow_notes/domain/entities/user.dart';
    import 'package:voiceflow_notes/presentation/pages/home_page.dart';
    import 'package:voiceflow_notes/presentation/pages/login_page.dart';
    import 'package:voiceflow_notes/presentation/providers/auth_provider.dart';

    class VoiceFlowApp extends ConsumerWidget {
      const VoiceFlowApp({super.key});

      @override
      Widget build(BuildContext context, WidgetRef ref) {
        final authState = ref.watch(authStateProvider);

        return MaterialApp(
          title: 'VoiceFlow Notes',
          debugShowCheckedModeBanner: false,
          theme: ThemeData(
            colorScheme: ColorScheme.fromSeed(seedColor: Colors.deepPurple),
            useMaterial3: true,
          ),
          darkTheme: ThemeData(
            colorScheme: ColorScheme.fromSeed(
              seedColor: Colors.deepPurple,
              brightness: Brightness.dark,
            ),
            useMaterial3: true,
          ),
          themeMode: ThemeMode.system,
          home: authState.when(
            data: (user) => user.isAuthenticated ? const HomePage() : const LoginPage(),
            loading: () => const Scaffold(
              body: Center(child: CircularProgressIndicator()),
            ),
            error: (_, __) => const LoginPage(),
          ),
        );
      }
    }
  </write>
</task>
```

**Files Modified:**
- `lib/presentation/pages/home_page.dart`
- `lib/presentation/app.dart`

**Must Haves for Success:**
- [ ] HomePage with logout button
- [ ] App switches between Login and Home based on auth
- [ ] Shows user info on HomePage

---

## Wave 6: Testing (15 min)

### Plan 02-11: Test Auth Flows

**Task:** Verify all auth functionality works

```xml
<task>
  <action>Build and verify compilation</action>
  <commands>
    flutter analyze
    flutter build apk --debug
  </commands>
  <verify>No errors</verify>
</task>

<task>
  <action>Test email/password sign up</action>
  <manual>
    1. Launch app
    2. Tap "Sign up" link
    3. Enter valid email and password
    4. Tap "Create Account"
    5. Verify: Success message appears
    6. Verify: Navigates to HomePage automatically
  </manual>
</task>

<task>
  <action>Test email/password sign in</action>
  <manual>
    1. Log out if logged in
    2. Enter existing email/password
    3. Tap "Sign In"
    4. Verify: Navigates to HomePage
    5. Verify: Shows correct user info
  </manual>
</task>

<task>
  <action>Test password reset</action>
  <manual>
    1. On LoginPage, tap "Forgot password?"
    2. Enter valid email
    3. Tap "Send Reset Link"
    4. Verify: Shows success message
    5. Verify: Email received (check inbox)
  </manual>
</task>

<task>
  <action>Test Google sign-in</action>
  <manual>
    1. On LoginPage, tap "Sign in with Google"
    2. Select Google account
    3. Verify: Navigates to HomePage
    4. Verify: Shows Google account info
  </manual>
</task>

<task>
  <action>Test session persistence</action>
    <manual>
    1. Log in with any method
    2. Force close app
    3. Reopen app
    4. Verify: Still logged in, goes directly to HomePage
  </manual>
</task>

<task>
  <action>Test error handling</action>
  <manual>
    1. Try sign in with wrong password
    2. Verify: Shows "Incorrect password" error
    3. Try sign up with existing email
    4. Verify: Shows "Already exists" error
    5. Try invalid email format
    6. Verify: Shows validation error
  </manual>
</task>
```

**Files Modified:** None (testing only)

**Must Haves for Success:**
- [ ] All auth flows work correctly
- [ ] Error messages are user-friendly
- [ ] Session persists across restarts
- [ ] Google sign-in works on device

---

## Verification Criteria

### Phase Success Criteria (from ROADMAP)

- [ ] New user can create account with email/password and see success confirmation
- [ ] User can sign in with Google OAuth and land on authenticated screen
- [ ] User receives password reset email within 60 seconds of requesting it
- [ ] Password reset flow completes successfully and allows new login
- [ ] Form validation shows clear error messages for invalid inputs
- [ ] Auth state persists across app restarts (token/refresh mechanism)

### Technical Verification

- [ ] Firebase project created and configured
- [ ] AuthRepository implemented with all methods
- [ ] All auth use cases created
- [ ] Riverpod providers configured
- [ ] Login, Register, ForgotPassword pages built
- [ ] Auth flow routing works
- [ ] Error handling for all auth errors
- [ ] `flutter build apk` succeeds

---

## Files Created/Modified

### New Files:
- `lib/domain/entities/user.dart` - User entity
- `lib/domain/repositories/auth_repository.dart` - Auth interface
- `lib/data/repositories/firebase_auth_repository.dart` - Firebase implementation
- `lib/domain/usecases/sign_in_usecase.dart` - Sign in use case
- `lib/domain/usecases/sign_up_usecase.dart` - Sign up use case
- `lib/domain/usecases/sign_out_usecase.dart` - Sign out use case
- `lib/domain/usecases/reset_password_usecase.dart` - Reset password use case
- `lib/domain/usecases/sign_in_with_google_usecase.dart` - Google sign in use case
- `lib/presentation/providers/auth_provider.dart` - Auth providers
- `lib/presentation/pages/login_page.dart` - Login UI
- `lib/presentation/pages/register_page.dart` - Register UI
- `lib/presentation/pages/forgot_password_page.dart` - Forgot password UI
- `lib/presentation/pages/home_page.dart` - Home placeholder
- `lib/firebase_options.dart` - Firebase config (generated)
- `android/app/google-services.json` - Firebase Android config

### Modified Files:
- `lib/core/errors/app_exception.dart` - Add AuthException
- `lib/core/utils/error_handler.dart` - Handle auth errors
- `lib/presentation/app.dart` - Auth-based routing
- `lib/main.dart` - Firebase initialization
- `pubspec.yaml` - Add firebase_auth, google_sign_in

---

## Dependencies Summary

| Package | Version | Purpose |
|---------|---------|---------|
| firebase_auth | ^5.5.1 | Authentication |
| google_sign_in | ^6.3.0 | Google OAuth |
| firebase_core | ^3.15.2 | Firebase foundation (already in Phase 1) |

---

## Next Phase

After Phase 2 completes:

**Phase 3: Navigation & UI Framework**
- go_router setup
- Splash screen
- Responsive layouts
- Navigation transitions

Run `/gsd-execute-phase 2` to execute this plan.

---

*Plan created: 2025-02-27*
*Ready for execution*
